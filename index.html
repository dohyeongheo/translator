<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ë‰˜ì•™ìŠ¤ í†µì—­ê¸° V11 (Simple)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Sarabun:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #121212;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        .thai-font {
            font-family: 'Sarabun', sans-serif;
        }

        .toss-dark {
            background-color: #1e1e1e;
            color: #f2f4f6;
        }

        .toss-input {
            background-color: #2c2c2c;
            border: none;
            color: white;
            transition: all 0.2s;
        }

        .toss-input:focus {
            background-color: #333;
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .toss-button {
            background-color: #3182f6;
            transition: all 0.2s;
        }

        .toss-button:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        /* ì–¸ì–´ ì„ íƒ ë²„íŠ¼ */
        .lang-btn {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            background-color: #2c2c2c;
            color: #a1a1aa;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* UI ì–¸ì–´ ìŠ¤ìœ„ì²˜ */
        .ui-lang-btn {
            opacity: 0.5;
            filter: grayscale(1);
            transition: all 0.2s;
        }

        .ui-lang-btn.active {
            opacity: 1;
            filter: grayscale(0);
            transform: scale(1.1);
        }

        /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        .pulse-text {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* ì„¤ì • ëª¨ë‹¬ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ (ê¸°ë³¸) */
        .mobile-only {
            display: block;
        }

        .desktop-only {
            display: none;
        }

        /* PC ìŠ¤íƒ€ì¼ - ë¯¸ë””ì–´ ì¿¼ë¦¬ë¡œ ì§ì ‘ ì ìš© */
        @media (min-width: 768px) {
            .container-wrapper {
                max-width: 1400px !important;
                margin: 0 auto;
                padding: 0 2rem;
            }

            .mobile-only {
                display: none;
            }

            .desktop-only {
                display: block;
            }

            header {
                padding: 2rem 2.5rem !important;
                border-radius: 0 0 1.5rem 1.5rem;
            }

            .lang-btn {
                padding: 10px 18px !important;
                font-size: 14px !important;
                border-radius: 10px;
            }

            #input-text {
                min-height: 200px !important;
                font-size: 18px !important;
                padding: 1.5rem !important;
            }

            #output-text {
                font-size: 2rem !important;
                line-height: 1.6;
            }

            .toss-button {
                width: 64px !important;
                height: 64px !important;
                font-size: 1.25rem !important;
            }

            .toss-button:hover {
                background-color: #2563eb;
                transform: scale(1.05);
            }

            .lang-btn:hover {
                background-color: #3b82f6;
                color: white;
            }

            main {
                padding: 2rem !important;
                max-width: 100%;
            }

            .toss-dark {
                padding: 2rem !important;
            }

            h1 {
                font-size: 1.75rem !important;
            }

            #result-card .toss-dark {
                padding: 2.5rem !important;
            }

            #nuance-group {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 1rem !important;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œë§Œ 2ì—´ ìœ ì§€ */
            @media (max-width: 767px) {
                #nuance-group {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
            }

            #nuance-group button {
                padding: 1.25rem !important;
                font-size: 14px !important;
            }
        }

        /* ëŒ€í˜• í™”ë©´ ìŠ¤íƒ€ì¼ (1920px ì´ìƒ) */
        @media (min-width: 1920px) {
            .container-wrapper {
                max-width: 1600px !important;
                padding: 0 3rem !important;
            }

            header {
                padding: 2.5rem 3rem !important;
            }

            main {
                padding: 3rem !important;
            }

            #input-text {
                min-height: 250px !important;
                font-size: 20px !important;
                padding: 2rem !important;
            }

            #output-text {
                font-size: 2.25rem !important;
            }

            .lang-btn {
                padding: 12px 22px !important;
                font-size: 15px !important;
            }

            .toss-button {
                width: 72px !important;
                height: 72px !important;
                font-size: 1.5rem !important;
            }

            h1 {
                font-size: 2rem !important;
            }

            .toss-dark {
                padding: 2.5rem !important;
            }

            #nuance-group {
                gap: 1.5rem !important;
            }

            #nuance-group button {
                padding: 1.5rem !important;
                font-size: 15px !important;
            }
        }

        /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        @media (max-width: 767px) {
            body.is-mobile .container-wrapper {
                max-width: 100%;
            }

            body.is-mobile header {
                padding: 1rem;
            }

            body.is-mobile .lang-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            body.is-mobile #input-text {
                min-height: 120px;
                font-size: 16px;
            }

            body.is-mobile #output-text {
                font-size: 1.5rem;
            }

            body.is-mobile .toss-button {
                width: 48px;
                height: 48px;
            }
        }

        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
        @media (hover: none) and (pointer: coarse) {
            .toss-button:active {
                transform: scale(0.95);
            }

            .lang-btn:active {
                transform: scale(0.98);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden bg-black">
    <div class="container-wrapper h-full flex flex-col">

        <!-- 1. Header & Global UI Switcher -->
        <header class="toss-dark p-4 pb-2 shrink-0 rounded-b-2xl shadow-lg z-10">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-black text-blue-400 flex items-center gap-2">
                    Nuance V11 <span class="text-[10px] bg-yellow-600 text-white px-2 py-0.5 rounded-full">LITE</span>
                </h1>
                <div class="flex gap-2">
                    <!-- Settings Button -->
                    <button onclick="toggleSettings()"
                        class="bg-black/30 p-2 rounded-full text-gray-400 hover:text-white transition">
                        <i class="fas fa-cog"></i>
                    </button>
                    <!-- UI Language Switcher -->
                    <div class="flex gap-2 bg-black/30 p-1.5 rounded-full">
                        <button onclick="setUILang('ko')" class="ui-lang-btn active text-lg">ğŸ‡°ğŸ‡·</button>
                        <button onclick="setUILang('th')" class="ui-lang-btn text-lg">ğŸ‡¹ğŸ‡­</button>
                        <button onclick="setUILang('en')" class="ui-lang-btn text-lg">ğŸ‡ºğŸ‡¸</button>
                    </div>
                </div>
            </div>

            <!-- Trans Language Selector -->
            <div class="flex items-center justify-between bg-black/30 p-1.5 rounded-xl mb-2">
                <div class="flex gap-1" id="source-lang-group">
                    <button data-lang="auto" class="lang-btn active" data-i18n="auto">ìë™</button>
                    <button data-lang="ko" class="lang-btn" data-i18n="ko">í•œêµ­ì–´</button>
                    <button data-lang="th" class="lang-btn" data-i18n="th">íƒœêµ­ì–´</button>
                    <button data-lang="en" class="lang-btn" data-i18n="en">ì˜ì–´</button>
                </div>
                <i class="fas fa-arrow-right text-gray-600 text-xs mx-1"></i>
                <div class="flex gap-1" id="target-lang-group">
                    <button data-lang="th" class="lang-btn active" data-i18n="th">íƒœêµ­ì–´</button>
                    <button data-lang="ko" class="lang-btn" data-i18n="ko">í•œêµ­ì–´</button>
                    <button data-lang="en" class="lang-btn" data-i18n="en">ì˜ì–´</button>
                </div>
            </div>
        </header>

        <!-- 2. Main Content -->
        <main class="flex-1 overflow-y-auto p-4 space-y-4 pb-32">

            <!-- Persona Settings (Simplified) -->
            <div class="toss-dark p-4 rounded-2xl border border-gray-800 space-y-3">
                <!-- Nuance (ë‰˜ì•™ìŠ¤) -->
                <div>
                    <h2
                        class="text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1">
                        <i class="fas fa-sliders text-purple-400"></i> <span data-i18n="nuance">ë‰˜ì•™ìŠ¤ (Tone)</span>
                    </h2>
                    <div class="grid gap-2" id="nuance-group" style="grid-template-columns: repeat(2, 1fr);">
                        <button data-tone="polite"
                            class="p-3 bg-[#2c2c2c] rounded-xl text-xs font-bold text-gray-400 hover:text-white active border-2 border-transparent transition-all">
                            ğŸ™ <span data-i18n="polite">ì˜ˆì˜ ë°”ë¥´ê²Œ</span>
                        </button>
                        <button data-tone="normal"
                            class="p-3 bg-[#2c2c2c] rounded-xl text-xs font-bold text-gray-400 hover:text-white border-2 border-transparent transition-all">
                            ğŸ˜ <span data-i18n="normal">ë³´í†µ</span>
                        </button>
                        <button data-tone="casual"
                            class="p-3 bg-[#2c2c2c] rounded-xl text-xs font-bold text-gray-400 hover:text-white border-2 border-transparent transition-all">
                            â˜• <span data-i18n="casual">í¸ì•ˆí•˜ê²Œ</span>
                        </button>
                        <button data-tone="playful"
                            class="p-3 bg-[#2c2c2c] rounded-xl text-xs font-bold text-gray-400 hover:text-white border-2 border-transparent transition-all">
                            ğŸ˜œ <span data-i18n="playful">ì¥ë‚œìŠ¤ëŸ½ê²Œ</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="relative">
                <textarea id="input-text"
                    class="w-full h-32 p-5 rounded-2xl toss-input text-lg leading-relaxed resize-none shadow-inner"
                    placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <button onclick="clearInput()" class="absolute top-3 right-3 text-gray-600 hover:text-gray-400 p-2">
                    <i class="fas fa-times-circle text-xl"></i>
                </button>
                <button onclick="executeTranslation()"
                    class="absolute bottom-3 right-3 toss-button text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fas fa-paper-plane text-lg"></i>
                </button>
            </div>

            <!-- Result Area -->
            <div id="result-card" class="hidden animate-pulse">
                <div class="toss-dark p-5 rounded-2xl border border-gray-700 shadow-2xl relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <span id="detected-lang-label"
                            class="text-[10px] font-bold bg-blue-900/50 text-blue-300 px-2 py-1 rounded">DETECTED</span>
                        <div class="flex gap-3">
                            <button onclick="copyResult()" class="text-gray-500 hover:text-white"><i
                                    class="far fa-copy"></i></button>
                            <button onclick="playTTS(state.lastResult, state.lastLang)"
                                class="text-blue-400 hover:text-blue-300"><i id="tts-icon"
                                    class="fas fa-volume-high text-xl"></i></button>
                        </div>
                    </div>
                    <p id="output-text" class="text-2xl font-bold text-white leading-relaxed thai-font break-words"></p>

                    <!-- Error Log -->
                    <div id="error-log"
                        class="hidden mt-4 p-3 bg-red-900/30 border border-red-800 rounded-lg text-xs text-red-300 font-mono break-all">
                    </div>

                    <!-- Loading -->
                    <div id="loading-spinner"
                        class="hidden absolute inset-0 bg-black/60 flex items-center justify-center backdrop-blur-sm">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-circle-notch fa-spin text-3xl text-blue-500 mb-2"></i>
                            <span class="text-xs text-blue-200 font-bold pulse-text" data-i18n="translating">AI ë²ˆì—­
                                ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div
            class="toss-dark w-full max-w-sm p-6 rounded-2xl shadow-2xl border border-gray-700 animate-in zoom-in-95 duration-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-key text-yellow-500"></i> API Settings
            </h2>
            <div class="mb-4">
                <label class="text-xs text-gray-400 font-bold mb-1 block">Google Gemini API Key</label>
                <input type="password" id="api-key-input"
                    class="w-full p-3 rounded-xl toss-input text-sm border border-gray-700 focus:border-blue-500"
                    placeholder="Paste your API key here...">
                <p class="text-[10px] text-gray-500 mt-2">
                    * 401 ì˜¤ë¥˜ ì‹œ ë³¸ì¸ì˜ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                    * í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()"
                    class="flex-1 p-3 rounded-xl bg-gray-700 text-gray-300 font-bold text-xs hover:bg-gray-600">ì·¨ì†Œ</button>
                <button onclick="saveApiKey()"
                    class="flex-1 p-3 rounded-xl bg-blue-600 text-white font-bold text-xs hover:bg-blue-500">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const defaultApiKey = "";

        // --- I18N DATA ---
        const I18N = {
            ko: {
                auto: "ìë™", ko: "í•œêµ­ì–´", th: "íƒœêµ­ì–´", en: "ì˜ì–´",
                nuance: "ë‰˜ì•™ìŠ¤ (Tone)", polite: "ì˜ˆì˜ ë°”ë¥´ê²Œ", normal: "ë³´í†µ", casual: "í¸ì•ˆí•˜ê²Œ", playful: "ì¥ë‚œìŠ¤ëŸ½ê²Œ",
                placeholder: "ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...", translating: "AI ë²ˆì—­ ì¤‘...",
                error: "ì˜¤ë¥˜ ë°œìƒ! ì„¤ì •(âš™ï¸)ì—ì„œ API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.", copied: "ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            },
            th: {
                auto: "à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´", ko: "à¹€à¸à¸²à¸«à¸¥à¸µ", th: "à¹„à¸—à¸¢", en: "à¸­à¸±à¸‡à¸à¸¤à¸©",
                nuance: "à¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡ (Tone)", polite: "à¸ªà¸¸à¸ à¸²à¸", normal: "à¸—à¸±à¹ˆà¸§à¹„à¸›", casual: "à¸à¸±à¸™à¹€à¸­à¸‡", playful: "à¸‚à¸µà¹‰à¹€à¸¥à¹ˆà¸™",
                placeholder: "à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ...", translating: "à¸à¸³à¸¥à¸±à¸‡à¹à¸›à¸¥...",
                error: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”! à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š API Key", copied: "à¸„à¸±à¸”à¸¥à¸­à¸à¹à¸¥à¹‰à¸§!"
            },
            en: {
                auto: "Auto", ko: "Korean", th: "Thai", en: "English",
                nuance: "Nuance", polite: "Polite", normal: "Normal", casual: "Casual", playful: "Playful",
                placeholder: "Type here...", translating: "Translating...",
                error: "Error! Check API Key in Settings.", copied: "Copied!"
            }
        };

        // --- STATE ---
        let state = {
            uiLang: 'ko',
            sourceLang: 'auto',
            targetLang: 'th',
            tone: 'polite',
            lastResult: '',
            lastLang: '',
            apiKey: defaultApiKey,
            isMobile: false,
            isDesktop: false
        };

        // --- DEVICE DETECTION ---
        function detectDevice() {
            const width = window.innerWidth;
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobileDevice = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);

            // í™”ë©´ í¬ê¸°ë¥¼ ìš°ì„ ì‹œí•˜ì—¬ íŒë‹¨ (í° í™”ë©´ì€ í•­ìƒ desktopìœ¼ë¡œ ì²˜ë¦¬)
            // width >= 768: desktop ìŠ¤íƒ€ì¼ ì ìš© (íƒœë¸”ë¦¿/í° í™”ë©´ ëª¨ë°”ì¼ í¬í•¨)
            // width < 768: mobile ìŠ¤íƒ€ì¼ ì ìš©
            if (width >= 768) {
                state.isMobile = false;
                state.isDesktop = true;
            } else {
                state.isMobile = true;
                state.isDesktop = false;
            }

            // bodyì— í´ë˜ìŠ¤ ì¶”ê°€/ì œê±° (í•­ìƒ í•˜ë‚˜ëŠ” ì¶”ê°€ë˜ë„ë¡ ë³´ì¥)
            document.body.classList.remove('is-mobile', 'is-desktop');
            if (state.isMobile) {
                document.body.classList.add('is-mobile');
            } else {
                document.body.classList.add('is-desktop');
            }

            // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì¡°ì • (CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ í´ë˜ìŠ¤ë§Œ ì œê±°)
            const container = document.querySelector('.container-wrapper');
            if (container) {
                if (state.isMobile) {
                    container.classList.remove('max-w-md', 'max-w-lg', 'max-w-xl', 'max-w-full');
                    container.classList.add('max-w-full');
                } else {
                    // PCì—ì„œëŠ” CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ê°€ max-widthë¥¼ ì„¤ì •í•˜ë¯€ë¡œ Tailwind í´ë˜ìŠ¤ ì œê±°
                    container.classList.remove('max-w-md', 'max-w-lg', 'max-w-xl', 'max-w-full');
                    // PC ë ˆì´ì•„ì›ƒ ê°•ì œ ì ìš©
                    container.style.maxWidth = '';
                }
            }
            
            // ë””ë²„ê¹…: PC ë ˆì´ì•„ì›ƒ í™•ì¸
            if (state.isDesktop) {
                console.log('PC ë ˆì´ì•„ì›ƒ ì ìš©ë¨:', {
                    width: width,
                    containerWidth: container ? container.offsetWidth : 'N/A',
                    isDesktop: state.isDesktop
                });
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // ë””ë°”ì´ìŠ¤ ê°ì§€
            detectDevice();

            // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì¬ê°ì§€
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    detectDevice();
                }, 150);
            });

            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) state.apiKey = savedKey;

            setupRadioButtons('source-lang-group', 'sourceLang', 'dataset.lang');
            setupRadioButtons('target-lang-group', 'targetLang', 'dataset.lang');
            setupRadioButtons('nuance-group', 'tone', 'dataset.tone');

            setActiveBtn('nuance-group', 'polite', 'border-blue-500', 'text-white', 'bg-blue-900/20');

            setUILang('ko');
        });

        // --- SETTINGS LOGIC ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const input = document.getElementById('api-key-input');

            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                input.value = state.apiKey;
            } else {
                modal.classList.add('hidden');
            }
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const newKey = input.value.trim();
            if (newKey) {
                state.apiKey = newKey;
                localStorage.setItem('gemini_api_key', newKey);
                alert("API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                toggleSettings();
            } else {
                alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }

        function setUILang(lang) {
            state.uiLang = lang;
            document.querySelectorAll('.ui-lang-btn').forEach(btn => btn.classList.remove('active'));
            const btns = document.querySelectorAll('.ui-lang-btn');
            if (btns.length >= 3) {
                if (lang === 'ko' && btns[0]) btns[0].classList.add('active');
                if (lang === 'th' && btns[1]) btns[1].classList.add('active');
                if (lang === 'en' && btns[2]) btns[2].classList.add('active');
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (I18N[lang] && I18N[lang][key]) el.innerText = I18N[lang][key];
            });
            const inputText = document.getElementById('input-text');
            if (inputText && I18N[lang]) inputText.placeholder = I18N[lang].placeholder;
        }

        function setupRadioButtons(groupId, stateKey, dataPath) {
            const container = document.getElementById(groupId);
            if (!container) {
                console.warn(`Container with id "${groupId}" not found`);
                return;
            }
            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelectorAll('button').forEach(b => {
                        b.classList.remove('active', 'border-blue-500', 'text-white', 'bg-blue-900/20');
                    });
                    btn.classList.add('active', 'border-blue-500', 'text-white', 'bg-blue-900/20');
                    const val = dataPath.includes('tone') ? btn.dataset.tone : btn.dataset.lang;
                    state[stateKey] = val;
                });
            });
        }

        function setActiveBtn(groupId, val, ...classes) {
            const container = document.getElementById(groupId);
            const selector = `[data-tone="${val}"]`;
            const btn = container.querySelector(selector);
            if (btn) btn.classList.add(...classes, 'active');
        }

        function clearInput() {
            document.getElementById('input-text').value = '';
            document.getElementById('result-card').classList.add('hidden');
            document.getElementById('input-text').focus();
        }

        // --- CORE LOGIC ---

        async function executeTranslation() {
            const text = document.getElementById('input-text').value.trim();
            if (!text) return;

            const resultCard = document.getElementById('result-card');
            const outputText = document.getElementById('output-text');
            const spinner = document.getElementById('loading-spinner');
            const errorLog = document.getElementById('error-log');

            resultCard.classList.remove('hidden');
            resultCard.classList.remove('animate-pulse');
            spinner.classList.remove('hidden');
            errorLog.classList.add('hidden');

            try {
                // FIXED PERSONA: Always Male Boss
                let personaDesc = "Gender: Male. ";
                if (state.tone === 'polite') personaDesc += "Tone: Very Polite & Formal. ";
                if (state.tone === 'normal') personaDesc += "Tone: Standard/Neutral. ";
                if (state.tone === 'casual') personaDesc += "Tone: Casual/Friendly. ";
                if (state.tone === 'playful') personaDesc += "Tone: Witty, Playful. ";

                const prompt = `
                Role: Expert AI Interpreter.
                Input: "${text}"
                Config: Source=${state.sourceLang}, Target=${state.targetLang}
                Persona: ${personaDesc}

                Rules:
                1. If Source is 'auto', detect language.
                2. Map languages: ko=Korean, th=Thai, en=English.
                3. If input is Thai/English -> Translate to Korean.
                4. If input is Korean -> Translate to Target (Default Thai).
                5. IMPORTANT: Apply the Persona Tone strictly. For Thai, ALWAYS use 'Krub' (Male ending).

                Output JSON ONLY: { "detectedSource": "LANG_CODE", "translatedText": "TEXT" }
                `;

                const currentKey = state.apiKey || defaultApiKey;
                const apiLLM = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`;

                const response = await fetch(apiLLM, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error("API Key Invalid (401)");
                    throw new Error(`API Request Failed: ${response.status}`);
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                    throw new Error("Invalid API response format");
                }

                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                if (!result.translatedText || !result.detectedSource) {
                    throw new Error("Invalid translation result format");
                }

                spinner.classList.add('hidden');
                outputText.innerText = result.translatedText;
                const detectedLabel = document.getElementById('detected-lang-label');
                if (detectedLabel) detectedLabel.innerText = result.detectedSource.toUpperCase();

                state.lastResult = result.translatedText;

                // Determine target language for TTS
                let ttsLang = state.targetLang;
                if (ttsLang === 'auto') {
                    ttsLang = (result.detectedSource === 'ko') ? 'th' : 'ko';
                }
                state.lastLang = ttsLang;

                // Use Browser Native TTS (Fast & Reliable)
                playTTS(result.translatedText, ttsLang);

            } catch (error) {
                console.error(error);
                spinner.classList.add('hidden');
                outputText.innerText = I18N[state.uiLang].error;

                errorLog.innerText = `Error: ${error.message}`;
                errorLog.classList.remove('hidden');

                if (error.message.includes("401")) {
                    setTimeout(() => toggleSettings(), 1500);
                }
            }
        }

        // BROWSER TTS (Native) - V7 Logic Restored
        function playTTS(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);

            if (lang === 'th') u.lang = 'th-TH';
            else if (lang === 'ko') u.lang = 'ko-KR';
            else if (lang === 'en') u.lang = 'en-US';
            else u.lang = 'th-TH';

            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        function copyResult() {
            navigator.clipboard.writeText(state.lastResult);
            alert(I18N[state.uiLang].copied);
        }

    </script>
</body>

</html>
